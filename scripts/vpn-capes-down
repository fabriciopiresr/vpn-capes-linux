#!/usr/bin/env bash

set -e

VPN_SCRIPT="/usr/local/bin/vpn.sh"

echo "[vpn-capes-down] Desconectando VPN..."

sudo "$VPN_SCRIPT" disconnect || true
sudo "$VPN_SCRIPT" stop || true

echo "[vpn-capes-down] Revertendo DNS e rotas..."
sudo resolvectl revert tunsnx

# Restaura Wi-Fi como rota padr√£o
ACTIVE_WIFI=$(nmcli -t -f DEVICE,TYPE,STATE dev | awk -F: '$2=="wifi" && $3=="connected"{print $1}')
if [ -n "$ACTIVE_WIFI" ]; then
  sudo resolvectl default-route "$ACTIVE_WIFI" yes
fi

# Fecha apenas o Firefox do perfil VPN
pkill -f "firefox.*-P vpn" || true

echo "[vpn-capes-down] VPN encerrada com sucesso."
