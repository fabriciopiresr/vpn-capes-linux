#!/usr/bin/env bash

set -e

VPN_SCRIPT="/usr/local/bin/vpn.sh"
IFACE="tunsnx"

DNS_CAPES=(
  172.19.100.16
  172.19.100.17
)

echo "[vpn-capes-up] Subindo chrootvpn..."
sudo "$VPN_SCRIPT" start

echo "[vpn-capes-up] Aplicando DNS e rota padrão da CAPES..."

sudo resolvectl dns "$IFACE" "${DNS_CAPES[@]}"
sudo resolvectl domain "$IFACE" "~fc.capes.gov.br"
sudo resolvectl default-route "$IFACE" yes

# Impede que o Wi-Fi sobrescreva a rota
ACTIVE_WIFI=$(nmcli -t -f DEVICE,TYPE,STATE dev | awk -F: '$2=="wifi" && $3=="connected"{print $1}')
if [ -n "$ACTIVE_WIFI" ]; then
  sudo resolvectl default-route "$ACTIVE_WIFI" no
fi

echo "[vpn-capes-up] Abrindo portal da CAPES..."
firefox "https://acessovpn.capes.gov.br" >/dev/null 2>&1 &

echo "[vpn-capes-up] Faça login no portal, selecione o certificado e clique em Conectar."
